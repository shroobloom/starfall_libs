--@name Brick
--@author shroobloom
--@server
--@include libs/custom_weapon.txt


local Weapon = require("libs/custom_weapon.txt")


local Brick = class("Brick", Weapon)
Brick.Classes = {}
Brick:addClass("pac_crowbar")

Brick.MASS = 384
Brick.SPEED = 4000
Brick.ANGULAR_SPEED = 80
Brick.StuffedWithRocks = true --TODO: require they be admin to activate this via command


local function stylize( Model )
    Model:setMaterial("sprops/sprops_plastic")
    Model:setColor( Color(220, 40, 30) )
end


function Brick:createModel()
    
    local BP, BA = self:localToWorld( Vector( 4, -3, 0 ), Angle() )
    
    local Brick = hologram.create( BP, BA, "models/props_junk/CinderBlock01a.mdl", Vector( 0.5, 0.5, 0.5 ) )
    stylize( Brick )
    self:addPart( Brick )
    
end



function Brick:onAnimationEvent( event, data )
    if event ~= 0 then return end
    if not prop.canSpawn() then return end
    
    local BrickProj = prop.create( self.Parts[1]:getPos(), self.Parts[1]:getAngles(), "models/props_junk/CinderBlock01a.mdl", false )
    stylize( BrickProj )
    
    BrickProj:enableDrag( false )
    BrickProj:setMass( Brick.MASS )
    BrickProj:applyForceCenter( self.Owner:getEyeAngles():getForward()*BrickProj:getMass()*Brick.SPEED )
    BrickProj:applyAngForce( Angle(math.random()-0.5, math.random()-0.5, math.random()-0.5)*BrickProj:getMass()*Brick.ANGULAR_SPEED )
    
    BrickProj:addCollisionListener(function( hit )
        if not isValid(hit.HitEntity) or not hit.HitEntity:isPlayer() or hit.HitEntity.Bricked then return end
        
        BrickProj:emitSound("physics/concrete/concrete_break3.wav")
        
        if Brick.StuffedWithRocks then
            concmd("ulx ragdoll \"$" .. hit.HitEntity:getSteamID() .. "\"")
            hit.HitEntity.Bricked = true
            
            timer.simple(3, function()
                if not isValid(hit.HitEntity) then return end
                
                concmd("ulx unragdoll \"$" .. hit.HitEntity:getSteamID() .. "\"")
                hit.HitEntity.Bricked = nil
            end)
        end
    end)
    
    self.Parts[1]:setNoDraw( true )
    
    timer.simple(0.35, function()
        self.Parts[1]:setNoDraw( false )
    end)
    
    timer.simple(5, function()
        BrickProj:remove()
    end)
end



Brick:new( owner() )